⠀⠀⢀⣤⣤⣤⣤⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⢸⣿⣿⣿⣿⣿⣷⡀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠘⠉⠉⠙⣿⣿⣿⣷⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⢸⣿⣿⣿⣧⠀⠀     aziz programming language,
⠀⠀⠀⠀⠀⠀⣼⣿⣿⣿⣿⣆⠀     a Common Lisp subset compiler
⠀⠀⠀⠀⠀⣼⣿⣿⣿⣿⣿⣿⡀     
⠀⠀⠀⠀⣴⣿⣿⣿⠟⣿⣿⣿⣷     built with xDSL
⠀⠀⠀⣰⣿⣿⣿⡏⠀⠸⣿⣿⣿⣇    
⠀⠀⢠⣿⣿⣿⡟⠀⠀⠀⢻⣿⣿⣿⡆   
⠀⢠⣿⣿⣿⡿⠀⠀⠀⠀⠀⢿⣿⣿⣷⣤⡄
⢀⣾⣿⣿⣿⠁⠀⠀⠀⠀⠀⠈⠿⣿⣿⣿⡇


compilation pipeline:

            Source Code (.aziz)
                    │
                    ├─── lexer
                    ▼
                Token Stream
                    │
                    ├─── parser
                    ▼
        Abstract Syntax Tree (AST)
                    │
                    ├─── IR generation
                    ▼
          aziz Dialect (Custom MLIR)
                    │
                    ├─── optimization
                    ▼
              Optimized MLIR
                    │
                    │
    ┌───────────────┼───────────────┐
    │               │               │
    ▼               ▼               ▼
Interpret     LLVM Backend    RISC-V Backend
                    │               │
                    ├─── lower      ├─── lower
                    ▼               ▼
              LLVM Dialect    RISC-V Dialect
                    │               │
                    ├─── emit       ├─── codegen
                    ▼               ▼
                 LLVM IR      RISC-V Assembly
                    │               │
                    ├─── compile    │
                    ▼               │
              Native Binary         │
                    │               │
                    ▼               ▼
                 Execute         Emulate

based on:

- https://mlir.llvm.org/docs/Tutorials/Toy/
- https://github.com/xdslproject/xdsl/tree/main/docs/Toy


$ uv run aziz-lang/main.py examples/rec-simple.aziz --all

  ╭──────────────────────────────────────────────────╮
  │                      source                      │
  ╰──────────────────────────────────────────────────╯

  (defun factorial (n)
    (if (<= n 1)
        1
        (* n (factorial (- n 1)))))
  (print (factorial 5))


  ╭──────────────────────────────────────────────────╮
  │                       ast                        │
  ╰──────────────────────────────────────────────────╯

  ModuleAST(
    ops=[
      FunctionAST(
        proto=PrototypeAST(
          name='factorial',
          args=[
            'n'
          ]
        ),
        body=[
          IfExprAST(
            cond=BinaryExprAST(
              op='<=',
              lhs=VariableExprAST(
                name='n'
              ),
              rhs=NumberExprAST(
                val=1
              )
            ),
            then_expr=NumberExprAST(
              val=1
            ),
            else_expr=BinaryExprAST(
              op='*',
              lhs=VariableExprAST(
                name='n'
              ),
              rhs=CallExprAST(
                callee='factorial',
                args=[
                  BinaryExprAST(
                    op='-',
                    lhs=VariableExprAST(
                      name='n'
                    ),
                    rhs=NumberExprAST(
                      val=1
                    )
                  )
                ]
              )
            )
          )
        ]
      ),
      PrintExprAST(
        arg=CallExprAST(
          callee='factorial',
          args=[
            NumberExprAST(
              val=5
            )
          ]
        )
      )
    ]
  )

  ╭──────────────────────────────────────────────────╮
  │                aziz dialect mlir                 │
  ╰──────────────────────────────────────────────────╯

  ModuleOp(
          builtin.module {
            "aziz.func"() ({
            ^bb0(%0 : i32):
              %1 = "aziz.constant"() {value = 1 : i32} : () -> i32
              %2 = "aziz.le"(%0, %1) : (i32, i32) -> i32
              %3 = "aziz.if"(%2) ({
                %4 = "aziz.constant"() {value = 1 : i32} : () -> i32
                "aziz.yield"(%4) : (i32) -> ()
              }, {
                %5 = "aziz.constant"() {value = 1 : i32} : () -> i32
                %6 = "aziz.sub"(%0, %5) : (i32, i32) -> i32
                %7 = "aziz.call"(%6) {callee = @factorial} : (i32) -> i32
                %8 = "aziz.mul"(%0, %7) : (i32, i32) -> i32
                "aziz.yield"(%8) : (i32) -> ()
              }) : (i32) -> i32
              "aziz.return"(%3) : (i32) -> ()
            }) {sym_name = "factorial", function_type = (i32) -> i32, sym_visibility = "private"} : () -> ()
            "aziz.func"() ({
              %9 = "aziz.constant"() {value = 5 : i32} : () -> i32
              %10 = "aziz.call"(%9) {callee = @factorial} : (i32) -> i32
              "aziz.print"(%10) : (i32) -> ()
              %11 = "aziz.constant"() {value = 0 : i32} : () -> i32
              "aziz.return"(%11) : (i32) -> ()
            }) {sym_name = "main", function_type = () -> i32} : () -> ()
          }
  )

  ╭──────────────────────────────────────────────────╮
  │                     llvm ir                      │
  ╰──────────────────────────────────────────────────╯

  ; ModuleID = 'LLVMDialectModule'
  source_filename = "LLVMDialectModule"

  @__str_fmt_d = internal constant [4 x i8] c"%d\0A\00"

  define i32 @factorial(i32 %0) {
    %2 = icmp sle i32 %0, 1
    br i1 %2, label %3, label %4

  3:                                                ; preds = %1
    br label %8

  4:                                                ; preds = %1
    %5 = sub i32 %0, 1
    %6 = call i32 @factorial(i32 %5)
    %7 = mul i32 %0, %6
    br label %8

  8:                                                ; preds = %3, %4
    %9 = phi i32 [ %7, %4 ], [ 1, %3 ]
    br label %10

  10:                                               ; preds = %8
    ret i32 %9
  }

  define i32 @main() {
    %1 = call i32 @factorial(i32 5)
    %2 = call i32 (ptr, ...) @printf(ptr @__str_fmt_d, i32 %1)
    ret i32 0
  }

  declare i32 @printf(ptr, ...)

  !llvm.module.flags = !{!0}

  !0 = !{i32 2, !"Debug Info Version", i32 3}


  ╭──────────────────────────────────────────────────╮
  │                  riscv assembly                  │
  ╰──────────────────────────────────────────────────╯

  .text
  .text
  .local factorial
  .p2align 2
  factorial:
          addi sp, sp, -104
          sd ra, 0(sp)
          sd s0, 8(sp)
          sd s1, 16(sp)
          sd s2, 24(sp)
          sd s3, 32(sp)
          sd s4, 40(sp)
          sd s5, 48(sp)
          sd s6, 56(sp)
          sd s7, 64(sp)
          sd s8, 72(sp)
          sd s9, 80(sp)
          sd s10, 88(sp)
          sd s11, 96(sp)
          mv s0, a0
          li s1, 1
          slt s1, s0, s1
          xori s1, s1, 1
          addi sp, sp, -8
          beq s1, zero, else_1
          li s1, 1
          sw s1, 0(sp)
          j cont_1
  else_1:
          li s1, 1
          sub s1, s0, s1
          mv a0, s1
          jal factorial
          mv s1, a0
          mul s0, s0, s1
          sw s0, 0(sp)
  cont_1:
          lw s0, 0(sp)
          addi sp, sp, 8
          mv a0, s0
          ld s0, 8(sp)
          ld s1, 16(sp)
          ld s2, 24(sp)
          ld s3, 32(sp)
          ld s4, 40(sp)
          ld s5, 48(sp)
          ld s6, 56(sp)
          ld s7, 64(sp)
          ld s8, 72(sp)
          ld s9, 80(sp)
          ld s10, 88(sp)
          ld s11, 96(sp)
          ld ra, 0(sp)
          addi sp, sp, 104
          ret
  .globl main
  .p2align 2
  main:
          li s0, 5
          mv a0, s0
          jal factorial
          mv s0, a0
          addi a0, s0, 0
          jal _print_int
          li zero, 0
          mv a0, zero
          li a7, 93
          ecall
          ret
  _print_string:
          mv t0, a0
          li t2, 268435456
  _ps_loop:
          lbu t1, 0(t0)
          beqz t1, _ps_done
          sb t1, 0(t2)
          addi t0, t0, 1
          j _ps_loop
  _ps_done:
          li t1, 10
          sb t1, 0(t2)
          ret
  _print_int:
          li t2, 268435456
          bnez a0, _pi_nz
          li t1, 48
          sb t1, 0(t2)
          j _pi_done
  _pi_nz:
          bgez a0, _pi_pos
          li t1, 45
          sb t1, 0(t2)
          neg a0, a0
  _pi_pos:
          mv t0, a0
          li t3, 10
          li t5, 0
  _pi_body_loop:
          beqz t0, _pi_body_print
          rem t1, t0, t3
          div t0, t0, t3
          addi t1, t1, 48
          addi sp, sp, -16
          sd t1, 0(sp)
          addi t5, t5, 1
          j _pi_body_loop
  _pi_body_print:
          beqz t5, _pi_body_end
          ld t1, 0(sp)
          addi sp, sp, 16
          sb t1, 0(t2)
          addi t5, t5, -1
          j _pi_body_print
  _pi_body_end:
  _pi_done:
          li t1, 10
          sb t1, 0(t2)
          ret
  _print_float:
          li t2, 268435456
          fcvt.w.d t0, fa0, rtz
          bgez t0, _pf_pos
          li t1, 45
          sb t1, 0(t2)
          neg t0, t0
  _pf_pos:
          bnez t0, _pf_int
          li t1, 48
          sb t1, 0(t2)
          j _pf_dot
  _pf_int:
          li t3, 10
          li t5, 0
  _pf_body_loop:
          beqz t0, _pf_body_print
          rem t1, t0, t3
          div t0, t0, t3
          addi t1, t1, 48
          addi sp, sp, -16
          sd t1, 0(sp)
          addi t5, t5, 1
          j _pf_body_loop
  _pf_body_print:
          beqz t5, _pf_body_end
          ld t1, 0(sp)
          addi sp, sp, 16
          sb t1, 0(t2)
          addi t5, t5, -1
          j _pf_body_print
  _pf_body_end:
  _pf_dot:
          li t1, 46
          sb t1, 0(t2)
          fcvt.w.d t0, fa0, rtz
          fcvt.d.w ft0, t0
          fsub.d fa0, fa0, ft0
          fabs.d fa0, fa0
          li t0, 1000000
          fcvt.d.w ft1, t0
          fmul.d fa0, fa0, ft1
          fcvt.w.d t0, fa0, rtz
          li t3, 10
          li t5, 0
          li t6, 6
  _pf_frac_loop:
          rem t1, t0, t3
          div t0, t0, t3
          addi t1, t1, 48
          addi sp, sp, -16
          sd t1, 0(sp)
          addi t5, t5, 1
          addi t6, t6, -1
          bnez t6, _pf_frac_loop
  _pf_frac_print:
          beqz t5, _pf_done
          ld t1, 0(sp)
          addi sp, sp, 16
          sb t1, 0(t2)
          addi t5, t5, -1
          j _pf_frac_print
  _pf_done:
          li t1, 10
          sb t1, 0(t2)
          ret


  ╭──────────────────────────────────────────────────╮
  │                interpreter output                │
  ╰──────────────────────────────────────────────────╯

  120


  ╭──────────────────────────────────────────────────╮
  │              riscv emulator output               │
  ╰──────────────────────────────────────────────────╯

  120


  ╭──────────────────────────────────────────────────╮
  │                   llvm output                    │
  ╰──────────────────────────────────────────────────╯

  120
